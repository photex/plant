#!/bin/sh

if [ -z "$PLANT_LISP" ]; then
    if [ -x `which sbcl` ]; then
        export PLANT_LISP=sbcl
    elif [ -x `which ccl` ]; then
        export PLANT_LISP=ccl
    elif [ -x `which clisp` ]; then
        export PLANT_LISP=clisp
    else
        echo "Unable to automatically find a suitable lisp for plant."
        echo "Please set the PLANT_LISP env var with the path to your lisp executable."
        exit 1
    fi
fi

if [ -z "$PLANT_HOME" ]; then
    plant_path=`readlink -f $0`
    export PLANT_HOME=`dirname $plant_path`
fi

export PLANT_BIN=${PLANT_HOME}/plant-bin

PLANT_BUILT=1
if [ ! -x ${PLANT_BIN} ]; then
    echo "Looks like this is the first time you're running plant."
    echo "I'm going to try and build it with either clisp, sbcl, or ccl."
    echo "If you don't have any of these then plant can't run."
    echo
    echo "Press any key to continue, or Ctrl-c to abort."
    read _

    if [ -x `which clisp` ]; then
        echo "Building plant with clisp"
        clisp -q \
            -x '(load "${PLANT_HOME}/asdf.lisp") (load "${PLANT_HOME}/build_plant.lisp")' \
            -- ${PLANT_BIN}
    elif [ -x `which sbcl` ]; then
        echo "Building plant with sbcl"
        sbcl --noinform \
            --load ${PLANT_HOME}/asdf.lisp \
            --script ${PLANT_HOME}/build_plant.lisp \
            ${PLANT_BIN}
    fi
    
    if [ -x ${PLANT_BIN} ]; then
        PLANT_BUILT=0
    fi
else
    PLANT_BUILT=0
fi

if [ ! ${PLANT_BUILT} ]; then
    echo "Unable to build plant. :("
    echo "Please consider providing any terminal output in a github issue."
    exit 1
fi

if [ -x `which ${PLANT_LISP}` ]; then
    ${PLANT_BIN} -- $@
else
    echo "plant currently only supports clisp, sbcl, and clozure-cl."
    exit 1
fi
